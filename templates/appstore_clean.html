{# ============================================================================
    æ–‡ä»¶å: appstore_clean.html
    åŠŸèƒ½:   åº”ç”¨å•†åº—é¡µé¢ï¼Œå±•ç¤ºå¯ä¸€é”®å®‰è£…çš„APPï¼ˆå®Œå…¨ä¿®å¤ç‰ˆæœ¬ï¼‰
    ä½œè€…: æ¢å®ä¼Ÿ <lianghongwei>ï¼Œé‚®ç®±: 287066024@qq.com
    åˆ›å»ºæ—¶é—´:20257-16
    æœ€åä¿®æ”¹:22517
    ä¿®å¤å†…å®¹:
      - ä¿®å¤æ‰€æœ‰JavaScriptè¯­æ³•é”™è¯¯
      - ä¿®å¤æ¨¡æ€æ¡†å…³é—­åç”»é¢å˜ç°é—®é¢˜
      - ä¿®å¤ä¸‰ç‚¹èœå•ä½ç½®åç§»é—®é¢˜
  ============================================================================ #}
{% extendsbase.html' %}
{% block title %}{{ _('åº”ç”¨å•†åº—') }} - åµŒå…¥å¼è½»nasç®¡ç†è½¯ä»¶{% endblock %}
{% block content %}
<div class="mb-4><div class="d-flex align-items-center justify-content-between mb-3>
    <div class="d-flex align-items-center">
      <i class="bi bi-shop fs-3 text-primary me-2i>
      <h3 class="fw-bold mb-0">[object Object][object Object]_('åº”ç”¨å•†åº—') }}</h3>
    </div>
    {% if current_user.is_admin %}
    <button class="btn btn-primary onclick=showAddAppModal()">
      <i class=bi bi-plus-circle me-1></i>{{ _(æ·»åŠ APP) }}
    </button>
  [object Object]% endif %}
  </div>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-44
    {% for app in apps %}
    <div class="col">
      <div class="card app-card h-10 border-0 position-relative" style=border-radius:12em;background:rgba(2552552555);backdrop-filter:blur(2);">
        {% if current_user.is_admin %}
        <div class=position-absolute top-0end-0 p-2style="z-index:10;">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" type="button data-bs-toggle="dropdown" aria-expanded="false>
              <i class=bi bi-three-dots-vertical></i>
            </button>
            <ul class="dropdown-menu>
              <li><a class="dropdown-itemhref="#onclick="editApp('{{ app|tojson|safe }}')>
                <i class=bibi-pencil me-1</i>{{ _('ç¼–è¾‘') }}
              </a></li>
              <li><a class="dropdown-item text-dangerhref="#" onclick=deleteApp('{{ app.name }}')>
                <i class="bi bi-trash me-1</i>{{ _('åˆ é™¤') }}
              </a></li>
            </ul>
          </div>
        </div>
  [object Object]% endif %}
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center" style=min-height: 200px; padding-top:3rem;">
          <i class=bi {{ app.icon }} display-3 mb-2 text-primary style="font-size:2.5em;" title="{{ app.description }}></i>
          <div class="fw-bold mb-1>{[object Object]app.name }}</div>
          <div class="text-muted small mb-1 style="max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{{ app.description }}">{{ app.description }}</div>
          <div class="text-secondary small mb-2
            {% if get_locale() == 'zh %}
              {{ app.category_zh or }}
            {% else %}
              {{ app.category_en or }}
            {% endif %}
          </div>
          {% set app_name = app.name.lower() %}
          {% if app_name in installed_names %}
            <button class=btn btn-secondary btn-sm mb-1led>
              {{ _('å·²å®‰è£…)if get_locale() ==zh else _('Installed') }}
            </button>
          {% else %}
            <button class="btn btn-outline-primary btn-sm mb-1-75click="showInstallModal(this) data-app='{{ app|tojson|safe }}'>
              {{ _('å®‰è£…)if get_locale() == 'zh' else _('Install') }}
            </button>
    [object Object]% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- æ·»åŠ APPæ¨¡æ€æ¡† -->
<div class="modal fade id="addAppModal" tabindex="-1data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class=modal-title" id="addAppModalLabel">{[object Object] _(æ·»åŠ æ–°APP) }}</h5      <button type="button class=btn-close" data-bs-dismiss=modal" aria-label=Close"></button>
      </div>
      <div class="modal-body">
        <form id="addAppForm">
          <div class=row">
            <div class="col-md-6>              <div class="mb-3>
                <label for="appName" class="form-label>{{ _('APPåç§°') }} *</label>
                <input type=textlass="form-control" id=appName" required>
              </div>
              <div class="mb-3>
                <label for=appImage" class="form-label>{[object Object]_(Dockeré•œåƒ') }} *</label>
                <input type=textlass="form-control" id="appImageplaceholder=ä¾‹å¦‚: nginx:latest" required>
              </div>
              <div class="mb-3>
                <label for="appIcon" class="form-label">{{ _('å›¾æ ‡') }}</label>
                <select class=form-select" id="appIcon">
                  <option value="bi-app">{{ _(é»˜è®¤
                  <option value=bi-film">{{ _(å½±éŸ³
                  <option value=bi-cloud">{{ _(äº‘ç›˜
                  <option value=bi-download">{{ _(ä¸‹è½½
                  <option value=bi-gear">{{ _(å·¥å…·
                  <option value=bi-database>{{ _('æ•°æ®åº“') }}</option>
                  <option value="bi-bar-chart">{{ _(ç›‘æ§
                  <option value=bi-house-door">{{ _(æ™ºèƒ½å®¶å±…') }}</option>
                  <option value="bi-shield-lock">{{ _(å®‰å…¨
                  <option value=bi-code-slash">{{ _(å¼€å‘n>
                </select>
              </div>
            </div>
            <div class="col-md-6>              <div class="mb-3>
                <label for="appCategoryZh" class="form-label">{{ _('ä¸­æ–‡åˆ†ç±»') }} *</label>
                <input type=textlass="form-control" id="appCategoryZh" required>
              </div>
              <div class="mb-3>
                <label for="appCategoryEn" class="form-label">{{ _('è‹±æ–‡åˆ†ç±»') }} *</label>
                <input type=textlass="form-control" id="appCategoryEn" required>
              </div>
              <div class="mb-3>
                <label for=appPorts" class="form-label">{{ _('ç«¯å£æ˜ å°„') }}</label>
                <input type=textlass="form-control" id="appPorts placeholder=ä¾‹å¦‚: 880>
                <div class=form-text>[object Object][object Object]_(æ ¼å¼ï¼šä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”') }}</div>
              </div>
            </div>
          </div>
          <div class="mb-3            <label for="appDescription" class="form-label">{{ _('æè¿°') }} *</label>
            <textarea class="form-control" id="appDescription" rows="3" required></textarea>
          </div>
          <div class="mb-3            <label for=appVolumes" class="form-label>{{_(æ•°æ®å·label>
            <input type=textlass="form-control" id="appVolumesplaceholder="ä¾‹å¦‚: /data/app:/app/data">
            <div class=form-text>[object Object][object Object]_(æ ¼å¼ï¼šä¸»æœºè·¯å¾„:å®¹å™¨è·¯å¾„ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”') }}</div>
          </div>
          <div class="mb-3            <label for="appEnv" class="form-label">{{ _('ç¯å¢ƒå˜é‡') }}</label>
            <textarea class="form-controlid="appEnv" rows="2placeholder="ä¾‹å¦‚: PASSWORD=123456G=true"></textarea>
            <div class=form-text">[object Object][object Object]_(æ ¼å¼ï¼šKEY=VALUEï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”') }}</div>
          </div>
        </form>
      </div>
      <div class="modal-footer>      <button type="button" class=btn btn-secondary" data-bs-dismiss=modal">{{ _(å–æ¶ˆ}</button>
        <button type="button" class="btn btn-primary" onclick="submitAddApp()">{{ _(æ·»åŠ  }}</button>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘APPæ¨¡æ€æ¡† -->
<div class="modal fade id=editAppModal" tabindex="-1data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class=modal-title id=editAppModalLabel">[object Object][object Object] _('ç¼–è¾‘APP) }}</h5      <button type="button class=btn-close" data-bs-dismiss=modal" aria-label=Close"></button>
      </div>
      <div class="modal-body">
        <form id="editAppForm">
          <input type="hidden" id="editAppOriginalName">
          <div class=row">
            <div class="col-md-6>              <div class="mb-3>
                <label for="editAppName" class="form-label>{{ _('APPåç§°') }} *</label>
                <input type=textlass="form-control id=tAppName" required>
              </div>
              <div class="mb-3>
                <label for="editAppImage" class="form-label>{[object Object]_(Dockeré•œåƒ') }} *</label>
                <input type=textlass="form-control id="editAppImage" required>
              </div>
              <div class="mb-3>
                <label for="editAppIcon" class="form-label">{{ _('å›¾æ ‡') }}</label>
                <select class=form-select" id="editAppIcon">
                  <option value="bi-app">{{ _(é»˜è®¤
                  <option value=bi-film">{{ _(å½±éŸ³
                  <option value=bi-cloud">{{ _(äº‘ç›˜
                  <option value=bi-download">{{ _(ä¸‹è½½
                  <option value=bi-gear">{{ _(å·¥å…·
                  <option value=bi-database>{{ _('æ•°æ®åº“') }}</option>
                  <option value="bi-bar-chart">{{ _(ç›‘æ§
                  <option value=bi-house-door">{{ _(æ™ºèƒ½å®¶å±…') }}</option>
                  <option value="bi-shield-lock">{{ _(å®‰å…¨
                  <option value=bi-code-slash">{{ _(å¼€å‘n>
                </select>
              </div>
            </div>
            <div class="col-md-6>              <div class="mb-3>
                <label for=editAppCategoryZh" class="form-label">{{ _('ä¸­æ–‡åˆ†ç±»') }} *</label>
                <input type=textlass="form-control" id=editAppCategoryZh" required>
              </div>
              <div class="mb-3>
                <label for=editAppCategoryEn" class="form-label">{{ _('è‹±æ–‡åˆ†ç±»') }} *</label>
                <input type=textlass="form-control" id=editAppCategoryEn" required>
              </div>
              <div class="mb-3>
                <label for="editAppPorts" class="form-label">{{ _('ç«¯å£æ˜ å°„') }}</label>
                <input type=textlass="form-control id="editAppPorts">
              </div>
            </div>
          </div>
          <div class="mb-3            <label for="editAppDescription" class="form-label">{{ _('æè¿°') }} *</label>
            <textarea class="form-control" id="editAppDescription" rows="3" required></textarea>
          </div>
          <div class="mb-3            <label for="editAppVolumes" class="form-label>{{_(æ•°æ®å·label>
            <input type=textlass="form-control" id=editAppVolumes>
          </div>
          <div class="mb-3            <label for=editAppEnv" class="form-label">{{ _('ç¯å¢ƒå˜é‡') }}</label>
            <textarea class="form-control" id="editAppEnv" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer>      <button type="button" class=btn btn-secondary" data-bs-dismiss=modal">{{ _(å–æ¶ˆ}</button>
        <button type="button" class="btn btn-primary" onclick="submitEditApp()">{{ _(ä¿å­˜ }}</button>
      </div>
    </div>
  </div>
</div>

<!-- å®‰è£…è¿›åº¦å¼¹çª— -->
<div class="modal fade id=installModal" tabindex="-1data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class=modal-title id=installModalLabel"><span id="installingTitle"></span></h5      <button type="button class=btn-close" data-bs-dismiss=modal" aria-label=Close"></button>
      </div>
      <div class="modal-body text-center>   <!-- é¡¶éƒ¨ loading åŠ¨ç”» -->
        <div class="mb-3        <div class=spinner-grow text-primary" role="status" style=width:2rem;height:2rem;">
            <span class=visually-hidden>Loading...</span>
          </div>
        </div>
        <!-- æ‹‰å–é•œåƒé˜¶æ®µï¼šä¸ç¡®å®šè¿›åº¦æ¡ -->
        <div id="progressIndeterminate" class="progress mb-2 style="height:15; display:none;">
          <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100></div>
        </div>
        <!-- å®‰è£…é˜¶æ®µï¼šç¡®å®šè¿›åº¦æ¡ -->
        <div id="progressDeterminate" class="progress mb-2 style="height:15; display:none;">
          <div class="progress-bar bg-success" role="progressbar"
               id="installProgressBarInner" style="width: 0%;>0%</div>
        </div>
        <!-- çŠ¶æ€æ–‡æœ¬ -->
        <div class="fw-bold" id=installStatusText">{{ _('Starting installation') }}</div>
      </div>
      <div class="modal-footer>      <button type="button" class="btn btn-outline-primary" id="continueBgBtn" data-bs-dismiss=modal"></button>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="position-fixed top-0 start-50translate-middle-x p-3style="z-index:9999></div>

<style>
#toast-container .toast [object Object]
  width: 360;
  min-width: 360;
  max-width: 360px;
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  text-align: center;
  box-sizing: border-box;
}
#toast-container .toast-body {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ä¿®å¤ä¸‰ç‚¹èœå•å®šä½é—®é¢˜ */
.app-card {
  transition: box-shadow 0.2, transform0.2position: relative;
}

.app-card:hover [object Object]
  box-shadow: 0 8px 32px rgba(0,0,0,00.18ansform: translateY(-4) scale(104;
}

/* ç¡®ä¿å¡ç‰‡å†…å®¹é«˜åº¦ä¸€è‡´ */
.app-card .card-body {
  min-height:200x;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding-top: 3; /* ä¸ºä¸‰ç‚¹èœå•ç•™å‡ºç©ºé—´ */
}

/* ä¸‰ç‚¹èœå•å›ºå®šå®šä½ */
.app-card .dropdown {
  position: absolute;
  top: 0.5m;
  right: 00.5rem;
  z-index:10

/* ä¿®å¤æ¨¡æ€æ¡†èƒŒæ™¯é—®é¢˜ */
.modal-backdrop[object Object]
  z-index: 140.modal[object Object]
  z-index: 1050;
}

/* ç¡®ä¿ä¸‹æ‹‰èœå•æ­£ç¡®æ˜¾ç¤º */
.dropdown-menu[object Object]
  z-index: 1060
</style>

<script>
// å…¨å±€å˜é‡
let currentModal = null;
let currentApp = null;
let installProgressTimer = null;
let lastProgress = 0

// å›½é™…åŒ–æ–‡æœ¬
const i18n = [object Object]  install: {{ _('å®‰è£…') }}",
  installed: {{ _('å·²å®‰è£…) }},
  starting: "[object Object]{ _('å¼€å§‹å®‰è£…) }}",
  pulling:{{ _('æ‹‰å–APPæºä¸­...) }},
  creating: {{ _(åˆ›å»ºAPPä¸­...') }}",
  finishing: {{ _('æ”¶å°¾ä¸­...) }},
  complete:{[object Object] _('å®‰è£…å®Œæˆï¼') }},
  failed: "[object Object]{ _(å®‰è£…å¤±è´¥') }}",
  app_deleted: {{ _('APPå·²åˆ é™¤') }},app_source_deleted: "{{ _('APPæºå·²åˆ é™¤') }}",
  confirm_app: {{ _('ç¡®å®šè¦åˆ é™¤è¯¥APPå—ï¼Ÿ') }},
  confirm_image: {{ _(ç¡®å®šè¦åˆ é™¤è¯¥APPæºå—ï¼Ÿ') }},
  installing: "{{ _('å®‰è£…ä¸­)if get_locale() ==zhelse _('Installing) }}",
  continue_bg: "{{ _(åå°å®‰è£…)if get_locale() == 'zh else _('Continue in background') }}",
  add_success: "{{ _('APPæ·»åŠ æˆåŠŸ') }},
  edit_success: "{{ _('APPæ›´æ–°æˆåŠŸ) }}",
  delete_success: "{{ _('APPåˆ é™¤æˆåŠŸ') }}",
  confirm_delete: {{ _('ç¡®å®šè¦åˆ é™¤è¯¥APPå—ï¼Ÿ) }}"
};

// æ¸…ç†æ¨¡æ€æ¡†èƒŒæ™¯
function cleanupModalBackdrop() {
  // ç§»é™¤æ‰€æœ‰modal-backdrop
  document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
    backdrop.remove();
  });
  
  // æ¸…ç†bodyæ ·å¼
  document.body.classList.remove('modal-open');
  document.body.style.overflow = ';
  document.body.style.paddingRight = '';
  
  console.log(æ¨¡æ€æ¡†èƒŒæ™¯å·²æ¸…ç†');
}

// æ˜¾ç¤ºæ¨¡æ€æ¡†
function showModal(modalId)[object Object]
  console.log('æ˜¾ç¤ºæ¨¡æ€æ¡†:', modalId);
  
  // å…ˆéšè—å½“å‰æ¨¡æ€æ¡†
  if (currentModal) [object Object]    currentModal.hide();
  }
  
  // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ®‹ç•™çš„èƒŒæ™¯å’Œæ ·å¼
  cleanupModalBackdrop();
  
  // åˆ›å»ºæ–°æ¨¡æ€æ¡†
  const modalElement = document.getElementById(modalId);
  if (modalElement) [object Object]    currentModal = new bootstrap.Modal(modalElement);
    currentModal.show();
    
    // ç›‘å¬éšè—äº‹ä»¶
    modalElement.addEventListener(hidden.bs.modal', function() {
      console.log('æ¨¡æ€æ¡†éšè—äº‹ä»¶è§¦å‘');
      cleanupModalBackdrop();
      currentModal = null;
    }, { once: true });
  }
}

// éšè—æ¨¡æ€æ¡†
function hideModal()[object Object]
  console.log('éšè—æ¨¡æ€æ¡†');
  if (currentModal) [object Object]    currentModal.hide();
  }
  cleanupModalBackdrop();
}

// æ˜¾ç¤ºæ·»åŠ APPæ¨¡æ€æ¡†
function showAddAppModal()[object Object]
  console.log('æ˜¾ç¤ºæ·»åŠ APPæ¨¡æ€æ¡†');
  document.getElementById('addAppForm).reset();
  showModal('addAppModal');
}

// æ˜¾ç¤ºç¼–è¾‘APPæ¨¡æ€æ¡†
function editApp(appData)[object Object]
  console.log('æ˜¾ç¤ºç¼–è¾‘APPæ¨¡æ€æ¡†');
  const app = JSON.parse(appData);
  document.getElementById('editAppOriginalName').value = app.name;
  document.getElementById('editAppName').value = app.name;
  document.getElementById('editAppImage').value = app.image;
  document.getElementById('editAppIcon').value = app.icon || 'bi-app';
  document.getElementById('editAppDescription').value = app.description;
  document.getElementById(editAppCategoryZh').value = app.category_zh;
  document.getElementById(editAppCategoryEn').value = app.category_en;
  
  // å¤„ç†ç«¯å£æ˜ å°„
  const ports =  (const [containerPort, hostPort] of Object.entries(app.default_ports || {})) {
    ports.push(`${hostPort}:${containerPort.replace('/tcp', '')}`);
  }
  document.getElementById('editAppPorts').value = ports.join(,);
  
  // å¤„ç†æ•°æ®å·
  const volumes = [];
  for (const volume of app.volumes || []) {
    if (typeof volume ===string) {      volumes.push(volume);
    } else if (volume.bind) {
      volumes.push(`${Object.keys(volume)0${volume.bind}`);
    }
  }
  document.getElementById(editAppVolumes).value = volumes.join(,);
  
  // å¤„ç†ç¯å¢ƒå˜é‡
  const envVars = [];
  for (const env of app.env || []) {
    if (typeof env ===string) {      envVars.push(env);
    }
  }
  document.getElementById('editAppEnv).value = envVars.join(',);
  
  showModal('editAppModal');
}

// åˆ é™¤APP
function deleteApp(appName) [object Object]  if (!confirm(i18n.confirm_delete)) return;
  
  fetch(/api/delete_app, {
    method: 'POST,headers: {'Content-Type':application/json},
    body: JSON.stringify({name: appName})
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === success')[object Object]     showToast(res.message || i18.delete_success,success;
      setTimeout(() => location.reload(),100    } else[object Object]     showToast(res.message || {{ _("åˆ é™¤å¤±è´¥") }}', danger);   }
  })
  .catch(() =>[object Object]
    showToast({{ _("ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥") }}',danger);
  });
}

// æäº¤æ·»åŠ APP
function submitAddApp() [object Object]  const formData = {
    name: document.getElementById(appName').value,
    image: document.getElementById('appImage).value,
    icon: document.getElementById(appIcon').value,
    description: document.getElementById(appDescription').value,
    category_zh: document.getElementById('appCategoryZh').value,
    category_en: document.getElementById('appCategoryEn').value,
    default_ports:[object Object],
    env: [],
    volumes: 
  };
  
  // å¤„ç†ç«¯å£æ˜ å°„
  const ports = document.getElementById('appPorts').value.split(',');
  ports.forEach(port => {
    if (port.trim()) {
      consthost, container] = port.split(':);  formData.default_ports[`${container.trim()}/tcp`] = parseInt(host.trim());
    }
  });
  
  // å¤„ç†æ•°æ®å·
  const volumes = document.getElementById('appVolumes').value.split(',');
  volumes.forEach(volume => {
    if (volume.trim())[object Object]      formData.volumes.push(volume.trim());
    }
  });
  
  // å¤„ç†ç¯å¢ƒå˜é‡
  const envVars = document.getElementById('appEnv').value.split(',');
  envVars.forEach(env => [object Object]   if (env.trim()) {
      formData.env.push(env.trim());
    }
  });
  
  fetch(/api/add_app, {
    method: 'POST,headers: {'Content-Type':application/json},
    body: JSON.stringify(formData)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === success')[object Object]     showToast(res.message || i18_success,success');
      hideModal();
      setTimeout(() => location.reload(),100    } else[object Object]     showToast(res.message || {{ _("æ·»åŠ å¤±è´¥") }}', danger);   }
  })
  .catch(() =>[object Object]
    showToast({{ _("ç½‘ç»œé”™è¯¯ï¼Œæ·»åŠ å¤±è´¥") }}',danger);
  });
}

// æäº¤ç¼–è¾‘APP
function submitEditApp() [object Object]  const formData = {
    name: document.getElementById('editAppName').value,
    image: document.getElementById('editAppImage).value,
    icon: document.getElementById('editAppIcon').value,
    description: document.getElementById('editAppDescription').value,
    category_zh: document.getElementById(editAppCategoryZh').value,
    category_en: document.getElementById(editAppCategoryEn').value,
    default_ports:[object Object],
    env: [],
    volumes: 
  };
  
  // å¤„ç†ç«¯å£æ˜ å°„
  const ports = document.getElementById('editAppPorts').value.split(',');
  ports.forEach(port => {
    if (port.trim()) {
      consthost, container] = port.split(':);  formData.default_ports[`${container.trim()}/tcp`] = parseInt(host.trim());
    }
  });
  
  // å¤„ç†æ•°æ®å·
  const volumes = document.getElementById(editAppVolumes').value.split(',');
  volumes.forEach(volume => {
    if (volume.trim())[object Object]      formData.volumes.push(volume.trim());
    }
  });
  
  // å¤„ç†ç¯å¢ƒå˜é‡
  const envVars = document.getElementById('editAppEnv').value.split(',');
  envVars.forEach(env => [object Object]   if (env.trim()) {
      formData.env.push(env.trim());
    }
  });
  
  fetch(/api/update_app, {
    method: 'POST,headers: {'Content-Type':application/json},
    body: JSON.stringify(formData)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === success')[object Object]     showToast(res.message || i18_success,success');
      hideModal();
      setTimeout(() => location.reload(),100    } else[object Object]     showToast(res.message || {{ _("æ›´æ–°å¤±è´¥") }}', danger);   }
  })
  .catch(() =>[object Object]
    showToast({{ _("ç½‘ç»œé”™è¯¯ï¼Œæ›´æ–°å¤±è´¥") }}',danger);
  });
}

// æ˜¾ç¤ºå®‰è£…æ¨¡æ€æ¡†
function showInstallModal(btn)[object Object]
  console.log('æ˜¾ç¤ºå®‰è£…æ¨¡æ€æ¡†');
  let app = JSON.parse(btn.dataset.app);
  currentApp = app;
  
  // è®¾ç½®å¤šè¯­è¨€æ ‡é¢˜å’ŒæŒ‰é’®
  document.getElementById('installingTitle).innerText = i18n.installing;
  document.getElementById('continueBgBtn).innerText = i18n.continue_bg;
  
  // é‡ç½®è¿›åº¦æ¡å’ŒçŠ¶æ€
  document.getElementById('progressIndeterminate).style.display = '';
  document.getElementById('progressDeterminate).style.display =none';
  let bar = document.getElementById('installProgressBarInner);
  let status = document.getElementById(installStatusText');
  bar.style.width =0%;
  bar.innerText = '0%;
  bar.classList.remove('bg-danger, 'bg-success);  status.innerText = i18.starting;
  
  // æ˜¾ç¤ºå¼¹çª—
  showModal('installModal);
  
  // å‘èµ·å®‰è£…è¯·æ±‚
  let data = {
    image: app.image,
    name: app.name.toLowerCase(),
    ports: app.default_ports ||[object Object],
    env: {},
    volumes: [object Object]  };
  
  fetch('/api/install_app, {
    method: 'POST,headers: {'Content-Type':application/json},
    body: JSON.stringify(data)
  }).then(r=>r.json()).then(res=>{
    if(res.status==='ok'){
      pollInstallProgress();
    }else{
      status.innerText = res.msg || i18n.failed;
      bar.classList.add('bg-danger');
      showToast(res.msg || i18ailed, danger');
    }
  });
}

// è½®è¯¢å®‰è£…è¿›åº¦
function pollInstallProgress() {
  let bar = document.getElementById('installProgressBarInner);
  let status = document.getElementById(installStatusText');
  let indeterminate = document.getElementById('progressIndeterminate');
  let determinate = document.getElementById('progressDeterminate');
  
  fetch('/api/install_progress').then(r=>r.json()).then(res=>{
    let p = res.progress;
    if (p === pulling     indeterminate.style.display = '';
      determinate.style.display = 'none';
      status.innerText = i18ulling;
      lastProgress = 0;
      installProgressTimer = setTimeout(pollInstallProgress, 50);
    } else if (typeof p ===number     indeterminate.style.display = 'none';
      determinate.style.display =      if (p > lastProgress) lastProgress = p;
      bar.style.width = lastProgress + '%;     bar.innerText = lastProgress + '%';
      if (lastProgress < 10&& lastProgress >= 0) {
        status.innerText = i18n.creating;
        installProgressTimer = setTimeout(pollInstallProgress, 500);
      } else if (lastProgress === 100     bar.classList.remove('bg-danger');
        bar.classList.add('bg-success');
        bar.innerText = '100%';
        status.innerText = i18n.complete;
        setTimeout(()=>location.reload(), 10);
      } else if (lastProgress ===-1     bar.classList.add('bg-danger);      status.innerText = i18iled;
        showToast(i18ailed, 'danger);
      }
    }
  });
}

// æ˜¾ç¤ºToastæ¶ˆæ¯
function showToast(msg, type=success) {
  let toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0 show`;
  toast.setAttribute(role',alert);
  toast.style.visibility =hidden
  toast.innerHTML = `
    <div class="d-flex">
      <div class=toast-body">${msg}</div>
      <button type="button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss=toast></button>
    </div>
  `;
  let container = document.getElementById('toast-container');
  container.appendChild(toast);
  requestAnimationFrame(() => {
    toast.style.visibility = visible  });
  setTimeout(() => toast.remove(), 3500);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function()[object Object]
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
  
  // åˆå§‹åŒ–ä¸‹æ‹‰èœå•
  var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
  var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
    return new bootstrap.Dropdown(dropdownToggleEl);
  });
  
  // æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ¨¡æ€æ¡†èƒŒæ™¯
  cleanupModalBackdrop();
  
  // ç›‘å¬æ‰€æœ‰å…³é—­æŒ‰é’®
  document.addEventListener('click,function(event) {
    if (event.target.classList.contains('btn-close') || 
        event.target.classList.contains('btn-secondary') ||
        event.target.getAttribute(data-bs-dismiss) === 'modal) {
      console.log('æ£€æµ‹åˆ°å…³é—­æŒ‰é’®ç‚¹å‡»');
      setTimeout(cleanupModalBackdrop, 100);
    }
  });
  
  // æ·»åŠ ç´§æ€¥æ¸…ç†æŒ‰é’®
  const emergencyBtn = document.createElement('button);
  emergencyBtn.innerHTML = 'ğŸ”§ ç´§æ€¥æ¸…ç†';
  emergencyBtn.className = 'btn btn-warning btn-sm position-fixed';
  emergencyBtn.style.cssText = top: 10px; right: 10px; z-index: 9999;';
  emergencyBtn.onclick = function()[object Object]
    console.log('ç´§æ€¥æ¸…ç†æŒ‰é’®è¢«ç‚¹å‡»');
    cleanupModalBackdrop();
    alert('æ¨¡æ€æ¡†èƒŒæ™¯å·²æ¸…ç†ï¼');
  };
  document.body.appendChild(emergencyBtn);
  
  // é¡µé¢å¸è½½æ—¶æ¸…ç†
  window.addEventListener('beforeunload', cleanupModalBackdrop);
  
  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ¸…ç†
  document.addEventListener('visibilitychange', function() [object Object]    if (document.hidden) {
      cleanupModalBackdrop();
    }
  });
});
</script>
{% endblock %}